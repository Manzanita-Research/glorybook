---
phase: 04-navigation-and-leader-controls
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/client/components/NavigationBar.tsx
  - src/client/components/SessionScreen.tsx
  - src/client/__tests__/NavigationBar.test.tsx
  - src/client/__tests__/SessionScreen.test.tsx
autonomous: true
requirements: [LEAD-01, LEAD-02, LEAD-03]

must_haves:
  truths:
    - "Leader taps next and live song advances to the next song for all connected users"
    - "Leader taps prev and live song goes back to the previous song for all connected users"
    - "Prev is disabled on the first song, next is disabled on the last song — no wrapping"
    - "Leader sees a persistent LEADER badge in the header bar"
    - "Bottom navigation bar shows song title and position (N of M) between prev/next arrows"
  artifacts:
    - path: "src/client/components/NavigationBar.tsx"
      provides: "Prev/next transport bar with song position display"
      min_lines: 30
    - path: "src/client/components/SessionScreen.tsx"
      provides: "Integration of NavigationBar and LEADER badge into session layout"
    - path: "src/client/__tests__/NavigationBar.test.tsx"
      provides: "Unit tests for navigation bar rendering and button states"
  key_links:
    - from: "src/client/components/NavigationBar.tsx"
      to: "useDeadSync actions"
      via: "onPrev/onNext callbacks passed from SessionScreen"
      pattern: "onPrev|onNext"
    - from: "src/client/components/SessionScreen.tsx"
      to: "src/client/use-deadsync.ts"
      via: "actions.setSong for leader, actions.browse for follower"
      pattern: "actions\\.(setSong|browse)"
---

<objective>
Build the bottom navigation bar (prev/next transport) and leader badge, wire both into SessionScreen.

Purpose: The leader can move through the setlist and everyone sees it. The leader's role is unambiguous on screen. This is the core sync-loop exercised end-to-end.
Output: NavigationBar component, LEADER badge in header, updated SessionScreen with navigation wired to useDeadSync actions.
</objective>

<execution_context>
@/Users/jem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/client/use-deadsync.ts
@src/shared/protocol.ts
@src/client/components/SessionScreen.tsx
@src/client/components/SongHeader.tsx
@src/client/app.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NavigationBar component with tests</name>
  <files>
    src/client/components/NavigationBar.tsx
    src/client/__tests__/NavigationBar.test.tsx
  </files>
  <action>
Create `NavigationBar.tsx` — a fixed bottom transport bar modeled after a music player.

**Props interface:**
```typescript
interface NavigationBarProps {
  songTitle: string;
  position: number;    // 1-based (e.g., 3)
  total: number;       // total songs (e.g., 8)
  onPrev: () => void;
  onNext: () => void;
}
```

**Layout:** Horizontal flex row inside the SessionScreen flex column (NOT position: fixed — use `shrink-0` so it sits below the scrollable chord chart naturally, same pattern as the header).

**Left:** Prev button — left-pointing chevron arrow (use inline SVG, no icon library). 48px min tap target (`min-w-12 min-h-12`). Disabled when `position === 1` — use `disabled:text-text-muted disabled:opacity-40` for greyed-out look.

**Center:** Song title (truncated, `text-text-primary font-medium`) on first line, "{position} of {total}" (`text-text-secondary text-sm`) below. Use `min-w-0 flex-1 text-center` for truncation to work.

**Right:** Next button — right-pointing chevron arrow. Same sizing as prev. Disabled when `position === total`.

**Styling:** `bg-surface-raised border-t border-border` for the container. The bottom bar should feel like a music player transport — `px-4 py-3`.

**Arrows:** Use simple inline SVG chevrons:
- Left: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><polyline points="15,18 9,12 15,6" /></svg>`
- Right: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><polyline points="9,6 15,12 9,18" /></svg>`
- SVG wrapper: `w-6 h-6`

**Tests (NavigationBar.test.tsx):**
- Renders song title and position text ("3 of 8")
- Prev button disabled when position is 1
- Next button disabled when position equals total
- Both buttons enabled for middle positions
- Prev button calls onPrev when clicked
- Next button calls onNext when clicked
- Does NOT call handler when disabled button is clicked
  </action>
  <verify>
    <automated>npx vitest run src/client/__tests__/NavigationBar.test.tsx</automated>
  </verify>
  <done>NavigationBar renders with prev/next arrows, song title, position display. Buttons disable at boundaries. Click handlers fire correctly.</done>
</task>

<task type="auto">
  <name>Task 2: Add LEADER badge and NavigationBar to SessionScreen</name>
  <files>
    src/client/components/SessionScreen.tsx
    src/client/__tests__/SessionScreen.test.tsx
  </files>
  <action>
Update `SessionScreen.tsx` to integrate NavigationBar and a LEADER badge.

**1. Destructure additional values from useDeadSync:**
Add `liveIndex`, `localIndex`, `isLive` to the existing destructured values. The hook already returns these.

**2. Add LEADER badge to the header:**
In the existing header `<div>` that shows the session code and role, replace the current role display with a proper badge:

- If `isLeader`: Show a `<span>` with text "LEADER" styled as a badge — `bg-accent-gold/20 text-accent-gold text-xs font-bold uppercase tracking-wider px-2 py-0.5 rounded`. This replaces the current star icon + "leader" text.
- If not leader: Show "follower" in `text-text-secondary` (minimal — Phase 5 will add "Led by [name]").

Keep the existing name display and connection indicator.

**3. Compute navigation values:**
```typescript
const songs = sessionState?.setlist.songs ?? [];
const total = songs.length;
const displayIndex = isLive ? liveIndex : localIndex;
const currentSong = songs[displayIndex] ?? null;
const position = displayIndex + 1;
```

Note: Remove the existing `currentSong`, `total`, and `position` computations which currently only use `liveIndex`. The new computation uses `displayIndex` which respects browse state.

**4. Create navigation handlers:**
```typescript
function handlePrev() {
  if (isLeader) {
    actions.setSong(liveIndex - 1);
  } else {
    actions.browse(displayIndex - 1);
  }
}

function handleNext() {
  if (isLeader) {
    actions.setSong(liveIndex + 1);
  } else {
    actions.browse(displayIndex + 1);
  }
}
```

Leader's prev/next always works from `liveIndex` (canonical server position). Follower's prev/next works from `displayIndex` (their local view).

**5. Add NavigationBar below ChordChart:**
Place `<NavigationBar>` as the last child of the outer flex column, AFTER the `flex-1 min-h-0` ChordChart wrapper. Pass `songTitle={currentSong?.title ?? ''}`, `position`, `total`, `onPrev={handlePrev}`, `onNext={handleNext}`.

**6. Update ChordChart props:**
Pass the new `position` and `total` values (already computed above) and `currentSong` to ChordChart. These replace the old hard-coded `liveIndex`-only computation.

**Layout structure after changes:**
```
<div className="h-dvh ... flex flex-col">
  {/* Header bar — shrink-0 */}
  <div>...</div>

  {/* Chord chart — flex-1 min-h-0, scrollable */}
  <div className="flex-1 min-h-0">
    <ChordChart ... />
  </div>

  {/* Navigation bar — shrink-0, sticks to bottom */}
  <NavigationBar ... />
</div>
```

**Update SessionScreen tests:**
- Verify LEADER badge renders when user is leader (mock isLeader: true)
- Verify "follower" text renders when user is not leader
- Verify NavigationBar is rendered with correct song title
- Keep existing tests working — update mocks if destructured values changed
  </action>
  <verify>
    <automated>npx vitest run src/client/__tests__/SessionScreen.test.tsx src/client/__tests__/NavigationBar.test.tsx</automated>
  </verify>
  <done>SessionScreen shows LEADER badge for leaders, "follower" for followers. NavigationBar appears at bottom with working prev/next. Leader taps change live song for all, follower taps browse locally. Prev disabled on first song, next disabled on last.</done>
</task>

</tasks>

<verification>
- `npx vitest run` — all existing and new tests pass
- NavigationBar shows prev/next arrows with 48px tap targets
- Song title and "N of M" position displayed between arrows
- Prev disabled on song 1, next disabled on last song
- LEADER badge visible in gold in header when user is leader
- "follower" text shown for non-leaders
- Leader pressing next calls `actions.setSong(liveIndex + 1)`
- Follower pressing next calls `actions.browse(displayIndex + 1)`
</verification>

<success_criteria>
Leader has working prev/next navigation in a bottom transport bar and a visible LEADER badge. The sync layer's `setSong` action is wired to the leader's controls. No changes to server or hook code — pure UI integration.
</success_criteria>

<output>
After completion, create `.planning/phases/04-navigation-and-leader-controls/04-01-SUMMARY.md`
</output>

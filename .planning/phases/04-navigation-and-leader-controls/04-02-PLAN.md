---
phase: 04-navigation-and-leader-controls
plan: 02
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - src/client/components/SetlistDrawer.tsx
  - src/client/components/TransferMenu.tsx
  - src/client/components/SessionScreen.tsx
  - src/client/__tests__/SetlistDrawer.test.tsx
  - src/client/__tests__/TransferMenu.test.tsx
  - src/client/__tests__/SessionScreen.test.tsx
autonomous: true
requirements: [LIST-01, LIST-02, LIST-03, LEAD-04]

must_haves:
  truths:
    - "Full setlist is visible in a drawer sidebar toggled by a hamburger icon"
    - "The current live song is highlighted with a gold left accent bar and bold text"
    - "Tapping a song in the sidebar browses to it locally without changing the live song for others"
    - "The drawer closes after a song is selected"
    - "Leader can long-press the LEADER badge to open a transfer menu showing connected users"
    - "Selecting a user in the transfer menu shows a confirmation dialog before transferring leadership"
    - "Leadership transfer calls actions.transferLead(userId)"
  artifacts:
    - path: "src/client/components/SetlistDrawer.tsx"
      provides: "Slide-out drawer listing all songs with live song highlight"
      min_lines: 40
    - path: "src/client/components/TransferMenu.tsx"
      provides: "Connected users list with transfer confirmation"
      min_lines: 30
    - path: "src/client/__tests__/SetlistDrawer.test.tsx"
      provides: "Tests for drawer rendering, song selection, live highlight"
    - path: "src/client/__tests__/TransferMenu.test.tsx"
      provides: "Tests for user list, confirmation, transfer action"
  key_links:
    - from: "src/client/components/SetlistDrawer.tsx"
      to: "useDeadSync actions"
      via: "onSelect callback calling actions.browse(index)"
      pattern: "onSelect|browse"
    - from: "src/client/components/TransferMenu.tsx"
      to: "useDeadSync actions"
      via: "onTransfer callback calling actions.transferLead(userId)"
      pattern: "onTransfer|transferLead"
    - from: "src/client/components/SessionScreen.tsx"
      to: "SetlistDrawer and TransferMenu"
      via: "boolean state toggles for drawer and transfer menu visibility"
      pattern: "drawerOpen|transferMenuOpen"
---

<objective>
Build the setlist drawer sidebar and leadership transfer menu, wire both into SessionScreen.

Purpose: Musicians can see the full setlist and jump to any song. The leader can hand off leadership mid-show. This completes Phase 4's navigation and control features.
Output: SetlistDrawer component, TransferMenu component, updated SessionScreen with drawer toggle and transfer flow.
</objective>

<execution_context>
@/Users/jem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-navigation-and-leader-controls/04-01-SUMMARY.md
@src/client/use-deadsync.ts
@src/shared/protocol.ts
@src/client/components/SessionScreen.tsx
@src/client/app.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SetlistDrawer and TransferMenu components with tests</name>
  <files>
    src/client/components/SetlistDrawer.tsx
    src/client/components/TransferMenu.tsx
    src/client/__tests__/SetlistDrawer.test.tsx
    src/client/__tests__/TransferMenu.test.tsx
  </files>
  <action>
**SetlistDrawer.tsx:**

Props:
```typescript
interface SetlistDrawerProps {
  open: boolean;
  songs: Song[];
  liveIndex: number;
  onSelect: (index: number) => void;
  onClose: () => void;
}
```

Structure:
- When `open` is false, render nothing (or render off-screen with `translate-x` for animation).
- When `open` is true, render:
  1. **Backdrop overlay:** `<div>` with `fixed inset-0 bg-black/50 z-40` and `onClick={onClose}`. Add `role="presentation"` for accessibility.
  2. **Drawer panel:** `<div>` with `fixed inset-y-0 left-0 w-72 max-w-[80vw] bg-surface-raised z-50 flex flex-col`. Use CSS transition: `transform transition-transform duration-200` with `translate-x-0` when open, `-translate-x-full` when closed.
  3. **Drawer header:** "Setlist" title in `px-4 py-3 border-b border-border text-text-primary font-bold text-lg`.
  4. **Song list:** `<ul>` with `flex-1 overflow-y-auto`. Each `<li>`:
     - If `index === liveIndex`: `border-l-4 border-accent-gold font-bold text-text-primary bg-surface-overlay/30` — gold left accent bar + bold + subtle background.
     - Otherwise: `text-text-secondary border-l-4 border-transparent` — keeps alignment consistent.
     - Each item: `px-4 py-3 cursor-pointer flex items-center gap-3`. On hover: `hover:bg-surface-overlay/50`.
     - Content: Song number (`text-sm text-text-muted w-6 text-right shrink-0`) + song title (`truncate`).
     - `onClick`: call `onSelect(index)` then `onClose()`.

Use proper animation pattern: always render the panel but control visibility with translate. The backdrop should only render when `open` is true.

**TransferMenu.tsx:**

Props:
```typescript
interface TransferMenuProps {
  open: boolean;
  users: SessionUser[];
  currentUserId: string | null;
  onTransfer: (userId: string) => void;
  onClose: () => void;
}
```

Structure:
- When `open` is false, render nothing.
- When `open` is true, render a modal-like overlay:
  1. **Backdrop:** `fixed inset-0 bg-black/60 z-50` with `onClick={onClose}`.
  2. **Menu panel:** Centered vertically and horizontally. `fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-72 max-w-[85vw] bg-surface-raised rounded-lg border border-border z-60 overflow-hidden`.
  3. **Title:** "Transfer Leadership" in `px-4 py-3 border-b border-border text-text-primary font-medium`.
  4. **User list:** Filter out current user (`users.filter(u => u.id !== currentUserId)`). Each user is a button: `w-full text-left px-4 py-3 text-text-secondary hover:bg-surface-overlay/50 hover:text-text-primary`. Shows user name.
  5. **Confirmation state:** When a user is tapped, switch to confirmation view (use `useState<string | null>` for `pendingUserId`):
     - Show: "Transfer leadership to {name}?" text.
     - Two buttons: "Cancel" (muted, calls `setPendingUserId(null)`) and "Transfer" (gold/interactive, calls `onTransfer(pendingUserId)` then `onClose()`).
     - Buttons: `min-h-12` for 48px tap targets. Transfer button: `bg-interactive text-surface font-medium rounded px-4`. Cancel: `text-text-secondary`.
  6. **Empty state:** If no other users, show "No other users connected" in `text-text-muted text-sm text-center py-6`.

**Tests (SetlistDrawer.test.tsx):**
- Renders nothing when `open` is false
- Renders song list when `open` is true
- Highlights the live song with bold text (check for `font-bold` class or similar)
- Calls onSelect with correct index when song is tapped
- Calls onClose when backdrop is clicked
- Calls onClose after song selection

**Tests (TransferMenu.test.tsx):**
- Renders nothing when `open` is false
- Renders user list (excluding current user) when open
- Shows confirmation when a user is tapped
- Calls onTransfer with correct userId after confirmation
- Calls onClose when cancel is clicked in confirmation
- Shows empty state when no other users exist
  </action>
  <verify>
    <automated>npx vitest run src/client/__tests__/SetlistDrawer.test.tsx src/client/__tests__/TransferMenu.test.tsx</automated>
  </verify>
  <done>SetlistDrawer shows song list with gold-highlighted live song. TransferMenu shows connected users with confirmation step. Both are self-contained, testable components.</done>
</task>

<task type="auto">
  <name>Task 2: Wire SetlistDrawer and TransferMenu into SessionScreen</name>
  <files>
    src/client/components/SessionScreen.tsx
    src/client/__tests__/SessionScreen.test.tsx
  </files>
  <action>
Update `SessionScreen.tsx` to integrate both new components.

**1. Add state for drawer and transfer menu:**
```typescript
const [drawerOpen, setDrawerOpen] = useState(false);
const [transferMenuOpen, setTransferMenuOpen] = useState(false);
```

**2. Add hamburger button to header:**
In the header bar, add a hamburger icon button as the FIRST element (before the session code). Use a simple inline SVG three-line hamburger:
```
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
  <line x1="3" y1="6" x2="21" y2="6" />
  <line x1="3" y1="12" x2="21" y2="12" />
  <line x1="3" y1="18" x2="21" y2="18" />
</svg>
```
Button: `min-w-12 min-h-12 flex items-center justify-center text-text-secondary` with `onClick={() => setDrawerOpen(true)}`. Add `aria-label="Open setlist"`.

**3. Add long-press to LEADER badge:**
The LEADER badge (added in Plan 04-01) needs a long-press handler for transfer. Implement with pointer events:

```typescript
const longPressTimerRef = useRef<ReturnType<typeof setTimeout>>(null);
const longPressFiredRef = useRef(false);

function handleBadgePointerDown() {
  if (!isLeader) return;
  longPressFiredRef.current = false;
  longPressTimerRef.current = setTimeout(() => {
    longPressFiredRef.current = true;
    setTransferMenuOpen(true);
  }, 500);
}

function handleBadgePointerUp() {
  if (longPressTimerRef.current) {
    clearTimeout(longPressTimerRef.current);
  }
}

// Cleanup on unmount
useEffect(() => {
  return () => {
    if (longPressTimerRef.current) clearTimeout(longPressTimerRef.current);
  };
}, []);
```

Add `onPointerDown={handleBadgePointerDown}` and `onPointerUp={handleBadgePointerUp}` and `onPointerCancel={handleBadgePointerUp}` to the LEADER badge span. Add `cursor-pointer select-none` to prevent text selection during long-press. Add `touch-action: none` via `touch-none` class to prevent scroll interference.

**4. Add drawer song selection handler:**
```typescript
function handleDrawerSelect(index: number) {
  actions.browse(index);
  setDrawerOpen(false);
}
```
Tapping a song in the sidebar ALWAYS calls `actions.browse()` — it navigates YOUR screen, not the live song. This is true for both leaders and followers per CONTEXT.md.

**5. Add transfer handler:**
```typescript
function handleTransfer(userId: string) {
  actions.transferLead(userId);
  setTransferMenuOpen(false);
}
```

**6. Render SetlistDrawer and TransferMenu:**
Place them OUTSIDE the main flex column (they're fixed-position overlays, not flex children):

```tsx
return (
  <>
    <div className="h-dvh ... flex flex-col">
      {/* Header */}
      {/* ChordChart */}
      {/* NavigationBar */}
    </div>

    <SetlistDrawer
      open={drawerOpen}
      songs={songs}
      liveIndex={liveIndex}
      onSelect={handleDrawerSelect}
      onClose={() => setDrawerOpen(false)}
    />

    {isLeader && (
      <TransferMenu
        open={transferMenuOpen}
        users={sessionState?.users ?? []}
        currentUserId={connectionId}
        onTransfer={handleTransfer}
        onClose={() => setTransferMenuOpen(false)}
      />
    )}
  </>
);
```

Note: Also destructure `connectionId` from useDeadSync (already returned by the hook).

**Update SessionScreen tests:**
- Verify hamburger button is rendered in header
- Verify clicking hamburger opens the SetlistDrawer (check for drawer content to appear)
- Verify SetlistDrawer receives correct songs and liveIndex
- Verify song selection in drawer calls actions.browse
- Verify TransferMenu renders only for leader
- Verify long-press logic is testable (or test at integration level by checking TransferMenu visibility after pointer events)
- Keep all existing tests passing
  </action>
  <verify>
    <automated>npx vitest run src/client/__tests__/SessionScreen.test.tsx src/client/__tests__/SetlistDrawer.test.tsx src/client/__tests__/TransferMenu.test.tsx</automated>
  </verify>
  <done>Hamburger button opens the setlist drawer. Songs listed with live song highlighted in gold. Tapping a song browses locally and closes drawer. Long-pressing LEADER badge opens transfer menu. Selecting a user and confirming transfers leadership. All wired to useDeadSync actions.</done>
</task>

</tasks>

<verification>
- `npx vitest run` — all existing and new tests pass
- Hamburger icon visible in top-left of header
- Drawer slides in from left showing full setlist
- Live song has gold left border accent and bold text
- Tapping a song browses locally (calls actions.browse) and closes drawer
- Drawer backdrop click closes drawer
- Long-press on LEADER badge opens transfer menu (only for leaders)
- Transfer menu shows connected users (excluding self)
- Confirmation step before transfer: "Transfer leadership to [name]?"
- Confirming calls actions.transferLead(userId)
- Cancel dismisses without transferring
</verification>

<success_criteria>
Setlist is accessible via hamburger drawer with live song highlighted. Leadership transfer is accessible via long-press on the LEADER badge with confirmation. Both features wired to the existing sync layer without any server or hook changes.
</success_criteria>

<output>
After completion, create `.planning/phases/04-navigation-and-leader-controls/04-02-SUMMARY.md`
</output>

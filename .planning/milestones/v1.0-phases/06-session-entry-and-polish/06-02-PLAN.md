---
phase: 06-session-entry-and-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/client/App.tsx
  - src/client/components/JoinScreen.tsx
  - src/client/__tests__/App.test.tsx
  - src/client/__tests__/JoinScreen.test.tsx
autonomous: true
requirements:
  - JOIN-04

must_haves:
  truths:
    - "Opening the app with ?code=scarlet-042 pre-fills the session code field on the join screen"
    - "After reading the URL param, the browser URL is cleaned (no stale ?code= on refresh)"
    - "Opening the app without ?code= shows a blank session code field as before"
  artifacts:
    - path: "src/client/App.tsx"
      provides: "URL parameter parsing for QR join flow"
      contains: "getCodeFromURL"
    - path: "src/client/components/JoinScreen.tsx"
      provides: "Accepts optional initialCode prop for pre-fill"
    - path: "src/client/__tests__/App.test.tsx"
      provides: "URL param parsing tests"
  key_links:
    - from: "src/client/App.tsx"
      to: "src/client/components/JoinScreen.tsx"
      via: "initialCode prop passed from URL param"
      pattern: "initialCode.*getCodeFromURL"
---

<objective>
Add URL-based session code pre-fill so scanning a QR code auto-fills the join screen.

Purpose: JOIN-04 (user scans QR code to join). When a musician scans the QR code on their phone, the native camera opens Safari with a URL like `https://host/?code=scarlet-042`. The app reads the `?code=` param, passes it to JoinScreen as a pre-filled value, and cleans the URL so refresh doesn't re-trigger.

Output: Modified App.tsx with URL param reading, modified JoinScreen with initialCode prop, unit tests.
</objective>

<execution_context>
@/Users/jem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-session-entry-and-polish/06-RESEARCH.md
@src/client/App.tsx
@src/client/components/JoinScreen.tsx
@src/client/__tests__/JoinScreen.test.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add URL param parsing to App.tsx and initialCode prop to JoinScreen</name>
  <files>
    src/client/App.tsx
    src/client/components/JoinScreen.tsx
  </files>
  <action>
In `App.tsx`:

1. Add a helper function before the App component:
```typescript
function getCodeFromURL(): string | null {
  const params = new URLSearchParams(window.location.search);
  const code = params.get("code");
  if (code) {
    // Clean up URL so refresh doesn't re-trigger pre-fill
    window.history.replaceState({}, "", window.location.pathname);
  }
  return code;
}
```

2. Inside the App component, before the return, add:
```typescript
const [initialCode] = useState(() => getCodeFromURL());
```

This uses lazy initialization so it only reads the URL once on mount. The `history.replaceState` cleans the URL immediately.

3. Pass initialCode to JoinScreen:
```tsx
<JoinScreen onJoin={handleJoin} initialCode={initialCode ?? undefined} />
```

In `JoinScreen.tsx`:

1. Add `initialCode?: string` to JoinScreenProps interface
2. Update the component signature to destructure `initialCode`
3. Change code state initialization from `useState("")` to `useState(initialCode ?? "")`

That's it — when initialCode is provided (from QR scan URL), the session code field is pre-filled. The user still needs to enter their name and tap Join. When no initialCode is provided, behavior is identical to before.
  </action>
  <verify>
    <automated>cd /Users/jem/code/manzanita-research/glorybook && npx vitest run src/client/__tests__/JoinScreen.test.tsx</automated>
  </verify>
  <done>App.tsx reads ?code= param and passes to JoinScreen. JoinScreen pre-fills session code from initialCode prop. URL is cleaned after reading.</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for URL param parsing and JoinScreen pre-fill</name>
  <files>
    src/client/__tests__/App.test.tsx
    src/client/__tests__/JoinScreen.test.tsx
  </files>
  <action>
Create `src/client/__tests__/App.test.tsx`:

Test the URL param reading behavior:

1. **Test: reads ?code= param and passes to JoinScreen as pre-filled value**
   - Set `window.location.search` to `?code=scarlet-042` (use `Object.defineProperty` or set up location mock)
   - Render `<App />`
   - Assert the session code input has value "scarlet-042"

2. **Test: cleans URL after reading ?code= param**
   - Set `window.location.search` to `?code=ripple-817`
   - Mock `window.history.replaceState`
   - Render `<App />`
   - Assert `replaceState` was called with `("", "", window.location.pathname)` (or equivalent args that strip the search param)

3. **Test: renders JoinScreen with empty code when no URL param**
   - Set `window.location.search` to `""`
   - Render `<App />`
   - Assert the session code input has value ""

Mock `useDeadSync` as done in other test files. Mock the theme utilities if they cause issues in jsdom.

In `src/client/__tests__/JoinScreen.test.tsx`:

Add to the existing test file:

4. **Test: pre-fills session code from initialCode prop**
   - Render `<JoinScreen onJoin={vi.fn()} initialCode="scarlet-042" />`
   - Assert the session code input has value "scarlet-042"

5. **Test: renders empty session code when no initialCode**
   - Render `<JoinScreen onJoin={vi.fn()} />`
   - Assert the session code input has value ""

For the App.test.tsx URL mocking approach: Use `delete window.location` + `Object.defineProperty` to set a custom location with the desired `search` and `pathname` values. Remember to restore after each test. Alternatively, extract `getCodeFromURL` and test it as a pure function by parameterizing the search string.
  </action>
  <verify>
    <automated>cd /Users/jem/code/manzanita-research/glorybook && npx vitest run src/client/__tests__/App.test.tsx src/client/__tests__/JoinScreen.test.tsx</automated>
  </verify>
  <done>URL param parsing tested: ?code= pre-fills JoinScreen, URL cleaned after read, no param means empty field. JoinScreen initialCode prop tested. All tests pass.</done>
</task>

</tasks>

<verification>
1. `npx vitest run` — full suite passes (no regressions)
2. App reads ?code= URL param and passes to JoinScreen
3. JoinScreen pre-fills session code from initialCode prop
4. URL is cleaned after reading param (no stale pre-fill on refresh)
</verification>

<success_criteria>
- Opening the app with `?code=scarlet-042` pre-fills the session code field
- The URL is cleaned (replaceState) after reading the param
- Opening without `?code=` works exactly as before
- All new and existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-session-entry-and-polish/06-02-SUMMARY.md`
</output>

---
phase: 06-session-entry-and-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/client/components/QRCodePanel.tsx
  - src/client/components/SessionScreen.tsx
  - src/client/__tests__/QRCodePanel.test.tsx
  - src/client/__tests__/SessionScreen.test.tsx
autonomous: true
requirements:
  - SESS-01
  - SESS-02

must_haves:
  truths:
    - "Leader sees a share button in the session header"
    - "Tapping the share button opens a QR code modal with the session code"
    - "The QR code encodes a URL containing the session code"
    - "The session code (Dead song name format) is displayed alongside the QR code"
    - "Followers do not see the share button"
    - "The QR modal can be dismissed to return to the chord chart"
  artifacts:
    - path: "src/client/components/QRCodePanel.tsx"
      provides: "QR code display modal for leader"
      exports: ["QRCodePanel"]
    - path: "src/client/__tests__/QRCodePanel.test.tsx"
      provides: "QRCodePanel unit tests"
  key_links:
    - from: "src/client/components/SessionScreen.tsx"
      to: "src/client/components/QRCodePanel.tsx"
      via: "isLeader conditional render with share button toggle"
      pattern: "isLeader.*QRCodePanel"
    - from: "src/client/components/QRCodePanel.tsx"
      to: "qrcode.react"
      via: "QRCodeSVG import"
      pattern: "QRCodeSVG"
---

<objective>
Add a QR code share panel for the session leader, so other musicians can scan to join.

Purpose: SESS-01 (leader displays QR code) and SESS-02 (Dead song session codes displayed). The leader taps a share button in the header, a modal appears with the QR code encoding the join URL and the session code shown in text. Followers never see the share button.

Output: QRCodePanel component, SessionScreen wiring, unit tests for both.
</objective>

<execution_context>
@/Users/jem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-session-entry-and-polish/06-RESEARCH.md
@src/client/components/SessionScreen.tsx
@src/client/__tests__/SessionScreen.test.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install qrcode.react and create QRCodePanel component with tests</name>
  <files>
    src/client/components/QRCodePanel.tsx
    src/client/__tests__/QRCodePanel.test.tsx
  </files>
  <action>
Install the dependency:
```bash
npm install qrcode.react
```

Create `src/client/components/QRCodePanel.tsx`:

Props: `sessionCode: string`, `onClose: () => void`

Build the join URL: `${window.location.origin}/?code=${sessionCode}`

Render a fixed overlay modal (z-50, bg-surface/90 backdrop) with:
- Heading "Join this session" in accent-gold
- Session code displayed in monospace text (text-lg, text-text-secondary) — this satisfies SESS-02 by showing the Dead song name code
- QRCodeSVG from qrcode.react encoding the join URL:
  - size={240} for scanability at 2-3 feet
  - level="M" for error correction
  - bgColor="#1a1410" (surface), fgColor="#f5f0e8" (cream) for theme match
  - marginSize={2}
- Helper text "Scan with your phone camera" below the QR
- "Done" button (min-h-[44px], bg-interactive) calling onClose

All interactive elements must have min-h-[44px] for iPad touch targets.

Create `src/client/__tests__/QRCodePanel.test.tsx`:
- Test: renders session code text
- Test: renders QRCodeSVG with correct value prop containing the session code in a URL
- Test: calls onClose when Done button is clicked
- Test: displays "Join this session" heading
- Mock qrcode.react if needed for jsdom compatibility, or use the real SVG render (qrcode.react works in jsdom).
  </action>
  <verify>
    <automated>cd /Users/jem/code/manzanita-research/glorybook && npx vitest run src/client/__tests__/QRCodePanel.test.tsx</automated>
  </verify>
  <done>QRCodePanel renders QR code with join URL, displays session code, and Done button dismisses it. All tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Wire QR share button into SessionScreen for leaders only</name>
  <files>
    src/client/components/SessionScreen.tsx
    src/client/__tests__/SessionScreen.test.tsx
  </files>
  <action>
In `SessionScreen.tsx`:

1. Import QRCodePanel from `./QRCodePanel`
2. Add state: `const [qrOpen, setQrOpen] = useState(false)`
3. In the header, next to the connection indicator (the `div` with `flex items-center gap-2`), add a share button BEFORE the connection dot, visible only when `isLeader`:
```tsx
{isLeader && (
  <button
    className="min-w-12 min-h-12 flex items-center justify-center text-text-secondary"
    onClick={() => setQrOpen(true)}
    aria-label="Share session"
  >
    {/* Simple share icon — square with arrow */}
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
      <path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8" />
      <polyline points="16 6 12 2 8 6" />
      <line x1="12" y1="2" x2="12" y2="15" />
    </svg>
  </button>
)}
```
4. Render QRCodePanel conditionally at the end of the component (after TransferMenu), inside the overlay section:
```tsx
{isLeader && qrOpen && (
  <QRCodePanel sessionCode={code} onClose={() => setQrOpen(false)} />
)}
```

Important: Use `code` prop (the session code the leader typed to create the room), NOT `sessionState.sessionCode`. The `code` prop is what maps to the PartyKit room name and is what joiners need to connect. See research open question 1.

In `SessionScreen.test.tsx`:
- Add test: leader sees "Share session" button
- Add test: follower does NOT see "Share session" button
- Add test: clicking share button opens QR panel (check for "Join this session" text)
- Add test: closing QR panel returns to normal view

Use the existing mock patterns from SessionScreen.test.tsx (vi.mock for useDeadSync).
  </action>
  <verify>
    <automated>cd /Users/jem/code/manzanita-research/glorybook && npx vitest run src/client/__tests__/SessionScreen.test.tsx src/client/__tests__/QRCodePanel.test.tsx</automated>
  </verify>
  <done>Leader sees share button in header, tapping opens QR modal with session code. Follower never sees share button. All tests pass.</done>
</task>

</tasks>

<verification>
1. `npx vitest run` — full suite passes (no regressions)
2. QRCodePanel renders QR code with join URL containing session code
3. Share button appears for leader only
4. QR modal opens and closes cleanly
</verification>

<success_criteria>
- Leader has a share button in the session header
- Tapping share opens a QR modal showing the session code and a scannable QR code
- Followers do not see the share button
- QR code encodes `{origin}/?code={sessionCode}` URL
- All new and existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-session-entry-and-polish/06-01-SUMMARY.md`
</output>

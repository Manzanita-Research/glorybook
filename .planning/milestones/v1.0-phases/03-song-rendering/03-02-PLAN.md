---
phase: 03-song-rendering
plan: 02
type: execute
wave: 2
depends_on:
  - "03-01"
files_modified:
  - src/client/components/ChordLine.tsx
  - src/client/components/BoxGridLine.tsx
  - src/client/components/SongHeader.tsx
  - src/client/components/ChordChart.tsx
  - src/client/components/SessionScreen.tsx
  - src/client/__tests__/ChordChart.test.tsx
  - src/client/__tests__/SongHeader.test.tsx
autonomous: true
requirements:
  - SONG-01
  - SONG-02
  - SONG-03
  - SONG-04
  - SONG-05

must_haves:
  truths:
    - "A chord chart renders on screen with bracket chords colored gold on dark pill badges"
    - "Section headers appear in bold blue uppercase text"
    - "Annotation lines appear in italic purple text"
    - "Song title, key, tempo, position, and notes are visible in a header above the chart"
    - "The header stays fixed while the chart body scrolls independently"
    - "Chart text is monospaced at minimum 20px for stage readability"
    - "The ChordChart component is wired into SessionScreen, replacing the placeholder"
  artifacts:
    - path: "src/client/components/ChordLine.tsx"
      provides: "Above-the-line chord+lyric rendering with gold chord badges"
      min_lines: 15
    - path: "src/client/components/BoxGridLine.tsx"
      provides: "Pipe-separated chord grid rendering"
      min_lines: 10
    - path: "src/client/components/SongHeader.tsx"
      provides: "Sticky header with title, key, tempo, position, notes"
      min_lines: 20
    - path: "src/client/components/ChordChart.tsx"
      provides: "Top-level chart component composing header + scrollable body"
      exports: ["ChordChart"]
      min_lines: 30
    - path: "src/client/__tests__/ChordChart.test.tsx"
      provides: "Component tests for chart rendering, color classes, scrollability"
      min_lines: 60
    - path: "src/client/__tests__/SongHeader.test.tsx"
      provides: "Component tests for header content and layout"
      min_lines: 30
  key_links:
    - from: "src/client/components/ChordChart.tsx"
      to: "src/client/lib/chord-tokenizer.ts"
      via: "import { tokenizeChart } from '../lib/chord-tokenizer'"
      pattern: "import.*tokenizeChart"
    - from: "src/client/components/ChordChart.tsx"
      to: "src/client/components/SongHeader.tsx"
      via: "import and render <SongHeader>"
      pattern: "<SongHeader"
    - from: "src/client/components/ChordChart.tsx"
      to: "src/client/components/ChordLine.tsx"
      via: "import and render <ChordLine>"
      pattern: "<ChordLine"
    - from: "src/client/components/SessionScreen.tsx"
      to: "src/client/components/ChordChart.tsx"
      via: "import and render <ChordChart> replacing placeholder"
      pattern: "<ChordChart"
    - from: "src/client/components/SongHeader.tsx"
      to: "src/shared/protocol.ts"
      via: "import type { Song }"
      pattern: "import.*Song"
---

<objective>
Build the rendering components (ChordLine, BoxGridLine, SongHeader, ChordChart) and wire them into the existing SessionScreen, replacing the "Setlist viewer coming soon" placeholder with a live chord chart display.

Purpose: This is the visual payoff — the musician sees the chord chart on screen with gold chords, blue sections, purple annotations, and a sticky song header. The chart is readable under stage lights on an iPad at arm's length.

Output: Four new components, two test files, one modified file (SessionScreen.tsx). The current song from sessionState renders as a color-coded chord chart.
</objective>

<execution_context>
@/Users/jem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-song-rendering/03-RESEARCH.md
@.planning/phases/03-song-rendering/03-01-SUMMARY.md
@src/client/components/SessionScreen.tsx
@src/client/app.css
@src/shared/protocol.ts
@src/shared/default-setlist.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create rendering components and tests</name>
  <files>
    src/client/components/ChordLine.tsx
    src/client/components/BoxGridLine.tsx
    src/client/components/SongHeader.tsx
    src/client/components/ChordChart.tsx
    src/client/__tests__/ChordChart.test.tsx
    src/client/__tests__/SongHeader.test.tsx
  </files>
  <action>
    Create four rendering components and their tests. All components use existing Tailwind theme tokens from app.css — no new CSS needed.

    **ChordLine.tsx** — Renders one chord-lyric line using above-the-line layout:
    - Takes `segments: ChordSegment[]` prop (from chord-tokenizer)
    - Each segment is an `inline-block` span containing two stacked block spans: chord badge on top, lyric text below
    - Chord badge: `text-accent-gold bg-surface-overlay/60 px-1 rounded text-sm leading-tight mb-0.5`
    - Lyric text: `text-text-primary` — use `seg.lyric || "\u00A0"` for empty lyrics (preserves alignment)
    - If a segment has `chord === ""` (leading lyric text), render only the lyric span with no chord badge above it
    - Outer container: `whitespace-pre font-mono`

    **BoxGridLine.tsx** — Renders one pipe-separated grid line:
    - Takes `raw: string` prop
    - Split on `|`, filter empty strings from leading/trailing pipes
    - Each cell: `inline-block border border-border px-2 py-0.5 text-accent-gold min-w-[3.5rem] text-center font-mono text-xl`
    - Cell content: `cell.trim() || "\u00A0"`
    - Container: `flex gap-0 font-mono text-xl my-1`

    **SongHeader.tsx** — Sticky header bar above the chart:
    - Takes `song: Song`, `position: number`, `total: number` props (Song from protocol.ts)
    - Layout: `bg-surface border-b border-border px-4 py-3 z-10`
    - Row 1: song title (text-2xl font-bold text-text-primary truncate) + position "N of M" (text-text-secondary text-sm shrink-0) — flex justify-between
    - Row 2: "Key: {key}" with key value in text-accent-gold, then tempo — flex gap-4 text-sm text-text-secondary
    - Row 3 (conditional): song.notes in `text-text-muted text-sm italic line-clamp-2` — only if notes exists
    - The header does NOT need `sticky top-0` because it sits outside the scroll container in the flex layout

    **ChordChart.tsx** — Top-level composition component:
    - Takes `song: Song`, `position: number`, `total: number` props
    - Uses `useMemo(() => tokenizeChart(song.chart), [song.chart])` to tokenize once
    - Layout: `flex flex-col h-full` (NOT h-dvh — the parent SessionScreen owns viewport height)
    - Renders `<SongHeader>` as first child
    - Renders chart body div `flex-1 overflow-y-auto px-4 py-4 font-mono text-xl` as second child
    - Chart body maps over parsed lines with a renderLine function:
      - "blank" → `<div key={i} className="h-4" />` (spacer)
      - "section" → `<div key={i} className="font-bold text-accent-blue uppercase mt-6 mb-2 tracking-wide">{trimmed text}</div>`
      - "annotation" → `<div key={i} className="italic text-accent-purple my-1">{text with leading > stripped}</div>`
      - "box-grid" → `<BoxGridLine key={i} raw={line.raw} />`
      - "chord-lyric" → `<ChordLine key={i} segments={line.segments!} />`
      - "plain" → `<div key={i} className="text-text-primary my-0.5">{trimmed text}</div>`

    **Tests:**

    ChordChart.test.tsx — test with a mock Song object containing representative chart text:
    - Renders song title in the header
    - Renders chord text with gold class (text-accent-gold)
    - Renders section header text with blue class (text-accent-blue)
    - Renders annotation text with purple class (text-accent-purple)
    - Chart body container has overflow-y-auto class
    - Chart body has font-mono class for monospace
    - Use @testing-library/react render + screen queries
    - Mock song: { id: "test", title: "Test Song", key: "G", tempo: "Medium", notes: "Test notes", chart: "CHORUS:\n[G]hello [Am]world\n> play softly\n|G   |C   |" }

    SongHeader.test.tsx — test with Song props:
    - Renders song title
    - Renders key value
    - Renders tempo
    - Renders position "N of M"
    - Renders notes when present
    - Does not render notes section when notes is undefined
  </action>
  <verify>
    <automated>bun run test src/client/__tests__/ChordChart.test.tsx src/client/__tests__/SongHeader.test.tsx</automated>
  </verify>
  <done>All rendering components exist and tests pass. Chord badges have gold styling, section headers have blue, annotations have purple. Chart body is scrollable. Header shows song metadata.</done>
</task>

<task type="auto">
  <name>Task 2: Wire ChordChart into SessionScreen</name>
  <files>
    src/client/components/SessionScreen.tsx
  </files>
  <action>
    Replace the "Setlist viewer coming soon" placeholder in SessionScreen.tsx with the ChordChart component wired to live session data.

    Modifications to SessionScreen.tsx:
    1. Add import: `import { ChordChart } from "./ChordChart";`
    2. Derive current song from session state: `const currentSong = sessionState?.setlist.songs[sessionState.liveIndex];`
    3. Replace the placeholder div (lines 107-111, the "Setlist viewer coming soon" block) with:
       ```tsx
       {currentSong ? (
         <ChordChart
           song={currentSong}
           position={(sessionState?.liveIndex ?? 0) + 1}
           total={sessionState?.setlist.songs.length ?? 0}
         />
       ) : (
         <div className="mt-8 text-center text-text-muted text-sm">
           <p>Waiting for setlist...</p>
         </div>
       )}
       ```
    4. Change the outer container from `min-h-dvh` to `h-dvh` and wrap the existing header area + user list in a non-scrolling section, then let ChordChart take the remaining vertical space with flex-1. The layout becomes:
       - Outer: `h-dvh bg-surface text-text-primary safe-area-padding flex flex-col`
       - Session info header area: existing content, wrapped in a non-growing div
       - ChordChart: `flex-1 min-h-0` wrapper (min-h-0 allows flex child to shrink below content size for overflow to work)
    5. The connected users list should move to a compact bar or be collapsed — for Phase 3, simply keep the session header (code + name + connection dot) and remove or collapse the full user list. The user list is Phase 5 (PRES-01, PRES-02) territory. For now, keep the header row with session code, user name/role, and connection indicator. Remove the "In session" user list section entirely — it will return in Phase 5 with proper presence indicators.
    6. Also remove the leaderDisconnected notice for now — it floats awkwardly above the chart. It returns in Phase 5 with proper status bar placement.

    The key layout change: SessionScreen becomes a flex column filling the viewport. The top ~60px is session info. Everything below is ChordChart, which has its own internal scroll.
  </action>
  <verify>
    <automated>bun run test</automated>
    <manual>Run `npx partykit dev` and open in browser. Verify the chord chart appears below the session header with colored chords and scrollable content.</manual>
  </verify>
  <done>SessionScreen renders ChordChart wired to sessionState. The placeholder is gone. The chart fills the available viewport below the session header. Existing tests still pass (SessionScreen tests may need mock updates for the removed user list).</done>
</task>

</tasks>

<verification>
1. `bun run test` — all tests pass (existing + new)
2. Visual check: chord chart renders with gold chords, blue sections, purple annotations
3. Song header shows title, key, tempo, position
4. Chart body scrolls independently of the header
5. Font is monospaced, visually ~20px
</verification>

<success_criteria>
The current song's chord chart is visible on screen. Chords are gold, sections are blue, annotations are purple. The song header is fixed at top. The chart scrolls. Text is monospaced and readable. All tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/03-song-rendering/03-02-SUMMARY.md`
</output>

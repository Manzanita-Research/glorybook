---
phase: 03-song-rendering
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/client/lib/chord-tokenizer.ts
  - src/client/__tests__/chord-tokenizer.test.ts
autonomous: true
requirements:
  - SONG-01
  - SONG-02

must_haves:
  truths:
    - "tokenizeLine classifies blank, section, annotation, box-grid, chord-lyric, and plain line types correctly"
    - "Chord segments extract chord name and following lyric text from bracket notation"
    - "Leading lyric text before the first chord is preserved as a segment with empty chord"
    - "Box grid lines with pipes are detected and not misclassified as chord-lyric"
    - "Section headers like CHORUS: and JAM SECTION: are detected without false positives on normal lyrics"
    - "Annotations starting with > or containing arrow or wrapped in parens are classified correctly"
  artifacts:
    - path: "src/client/lib/chord-tokenizer.ts"
      provides: "tokenizeLine and tokenizeChart pure functions"
      exports: ["tokenizeLine", "tokenizeChart", "ParsedLine", "ChordSegment", "LineType"]
    - path: "src/client/__tests__/chord-tokenizer.test.ts"
      provides: "Unit tests for all line type classifications and edge cases"
      min_lines: 80
  key_links:
    - from: "src/client/__tests__/chord-tokenizer.test.ts"
      to: "src/client/lib/chord-tokenizer.ts"
      via: "import { tokenizeLine, tokenizeChart }"
      pattern: "import.*tokenize"
---

<objective>
Build the chord tokenizer — a pure function that takes a chart string and returns typed tokens for each line. This is the data layer that all rendering components depend on.

Purpose: The tokenizer is the foundation of chord chart rendering. Getting the line classification and chord/lyric segment extraction right (with tests proving it) prevents bugs from cascading into the visual layer.

Output: `chord-tokenizer.ts` with full test coverage, all line types handled, edge cases from the actual default setlist verified.
</objective>

<execution_context>
@/Users/jem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-song-rendering/03-RESEARCH.md
@src/shared/default-setlist.ts
</context>

<feature>
  <name>Chord chart line tokenizer</name>
  <files>src/client/lib/chord-tokenizer.ts, src/client/__tests__/chord-tokenizer.test.ts</files>
  <behavior>
    tokenizeLine(line) classifies each line and extracts structured data:

    Line type classification:
    - "" → { type: "blank", raw: "" }
    - "CHORUS:" → { type: "section", raw: "CHORUS:" }
    - "JAM SECTION:" → { type: "section", raw: "JAM SECTION:" }
    - "> some note" → { type: "annotation", raw: "> some note" }
    - "→ TRANSITION TO FIRE" → { type: "annotation", raw: "→ TRANSITION ..." }
    - "(stage direction here)" → { type: "annotation", raw: "(stage direction here)" }
    - "|G   |C   |D   |%   |" → { type: "box-grid", raw: "|G   |C   |..." }
    - "A lit up and the [G]boys" → { type: "chord-lyric", raw: "...", segments: [...] }
    - "Just plain lyrics" → { type: "plain", raw: "Just plain lyrics" }

    Chord segment extraction for chord-lyric lines:
    - "[G]boys were drinkin'" → segments: [{ chord: "G", lyric: "boys were drinkin'" }]
    - "A lit up and the [G]boys" → segments: [{ chord: "", lyric: "A lit up and the " }, { chord: "G", lyric: "boys" }]
    - "[G]  [C]  [D]" → segments: [{ chord: "G", lyric: "  " }, { chord: "C", lyric: "  " }, { chord: "D", lyric: "" }]
    - "[C/G]walking" → segments: [{ chord: "C/G", lyric: "walking" }]

    tokenizeChart(chart) splits on newline and maps tokenizeLine over all lines.

    Edge cases to test (from actual default setlist):
    - "BRIDGE:  [D] → [Am] → [G]  (repeat 2x, jam here)" — this starts with BRIDGE: but also has chords. The section header regex fires first (it matches the uppercase-colon pattern), so this is type "section". The chord extraction is NOT needed for section lines.
    - "A lit up and the [G]boys were drinkin'" — leading lyric text before first chord must be captured as { chord: "", lyric: "A lit up and the " }
    - "[B] [E] [B] [E] — open jam, build intensity" — chord-lyric with trailing annotation-like text. Classified as chord-lyric because it has brackets. The "— open jam" is part of the last segment's lyric.
    - Box grid: line must start with | AND have at least two pipes (regex: /^\|[^|]+\|/)
    - Section header: /^[A-Z][A-Z\s\/\-]+:/ — requires 2+ uppercase chars before colon, checked BEFORE chord-lyric detection
    - Annotation: checked BEFORE chord-lyric — lines starting with > or containing → or fully wrapped in parens

    Priority order for classification (first match wins):
    1. blank (empty/whitespace only)
    2. box-grid (starts with |, has 2+ pipes)
    3. section (uppercase-colon pattern)
    4. annotation (>, →, or full-paren wrap)
    5. chord-lyric (contains [ bracket)
    6. plain (everything else)
  </behavior>
  <implementation>
    Create src/client/lib/chord-tokenizer.ts with:

    Types: LineType union, ChordSegment interface, ParsedLine interface (all exported).

    tokenizeLine(line: string): ParsedLine — classification in priority order above. For chord-lyric lines, extract segments using a split approach: split the line on bracket boundaries, capture leading text before first chord as { chord: "", lyric: prefix }. Use regex /\[([^\]]+)\]/g with string splitting (not just exec loop) to handle leading text.

    tokenizeChart(chart: string): ParsedLine[] — split on \n, map tokenizeLine.

    isAnnotation(line: string): boolean — helper for >, →, full-paren detection.

    Key implementation notes:
    - Section header check MUST come before chord-lyric check (BRIDGE: [D] → [Am] lines are sections, not chord-lyrics)
    - Annotation check MUST come before chord-lyric check (→ TRANSITION lines are annotations even if they contain brackets)
    - Box grid requires /^\|.*\|/ (starts with pipe AND has second pipe)
    - For chord-lyric leading text: split the line by /(\[[^\]]+\])/ to get alternating text/bracket parts, then pair them into ChordSegment[]
  </implementation>
</feature>

<verification>
bun run test src/client/__tests__/chord-tokenizer.test.ts
</verification>

<success_criteria>
All tokenizer tests pass. Every line type from the default setlist is correctly classified. Leading lyric text is preserved. No false positives on section headers or box grids.
</success_criteria>

<output>
After completion, create `.planning/phases/03-song-rendering/03-01-SUMMARY.md`
</output>
